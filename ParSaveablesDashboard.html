<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disc Golf Season Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .refresh-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.05);
        }
        
        /* Chat Section - Top */
        .chat-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .chat-header {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .chat-box {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .bot-message {
            background: white;
            border: 1px solid #e0e0e0;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        #chatInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1em;
        }
        
        #sendBtn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        #sendBtn:hover {
            background: #5568d3;
        }
        
        #sendBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Dashboard Layout - 3 Rows */
        .row {
            margin-bottom: 20px;
        }
        
        .row-1 {
            display: grid;
            grid-template-columns: 1fr;
        }
        
        .row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .row-3 {
            display: grid;
            grid-template-columns: 1fr;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .scrollable-table {
            max-height: 450px;
            overflow-y: auto;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            color: white;
        }
        
        .rank-1 { background: gold; color: #333; }
        .rank-2 { background: silver; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #667eea; }
        
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .player-name {
            min-width: 120px;
            font-weight: 600;
        }
        
        .bars {
            display: flex;
            flex: 1;
            gap: 2px;
            height: 25px;
        }
        
        .bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            border-radius: 3px;
        }
        
        .bar-ace { background: #e74c3c; }
        .bar-eagle { background: #f39c12; }
        .bar-birdie { background: #27ae60; }
        
        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .row-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü•è Disc Golf Season Tracker</h1>
            <p>Track your season stats and ask questions!</p>
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh Data</button>
        </header>

        <!-- Chatbot Section - Top -->
        <div class="chat-section">
            <h2 class="chat-header">üí¨ Ask About Stats</h2>
            <div class="chat-box" id="chatBox">
                <div class="message bot-message">
                    Hi! Ask me anything about your disc golf season stats. Try:
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li>"Who is winning the season?"</li>
                        <li>"What's my average score?"</li>
                        <li>"Show me player stats for David"</li>
                        <li>"Best round at Zilker?"</li>
                    </ul>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask a question..." onkeypress="handleKeyPress(event)">
                <button id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Row 1: Season Leaderboard -->
        <div class="row row-1">
            <div class="card">
                <h2>üèÜ Season Leaderboard</h2>
                <div class="scrollable-table">
                    <div id="leaderboard" class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Row 2: Ace/Eagle/Birdie Leaders & Courses Played -->
        <div class="row row-2">
            <div class="card">
                <h2>üéØ Aces/Eagles/Birdies</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color bar-ace"></div>
                        <span>Aces</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color bar-eagle"></div>
                        <span>Eagles</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color bar-birdie"></div>
                        <span>Birdies</span>
                    </div>
                </div>
                <div class="scrollable-table">
                    <div id="birdieLeaders" class="loading">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h2>üèûÔ∏è Average Score by Course Tiers</h2>
                <div class="scrollable-table">
                    <div id="coursesTable" class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Row 3: Weekly Points Trend -->
        <div class="row row-3">
            <div class="card">
                <h2>üìà Monthly Points Trend</h2>
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE THESE VALUES!
        // ============================================
        const SUPABASE_URL = 'https://bcovevbtcdsgzbrieiin.supabase.co';  // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjb3ZldmJ0Y2RzZ3picmllaWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzA3OTEsImV4cCI6MjA3NjIwNjc5MX0.etzrLL8yw4n_NUdYnr_bdcrKphW67dYln8CjR54NSLA';  // Long string starting with 'eyJ...'
        const N8N_CHATBOT_URL = 'https://golden-unslouched-aggravatedly.ngrok-free.dev/webhook-test/chatbot';  // e.g., 'http://localhost:5678/webhook/chatbot'

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let monthlyTrendChart;

        // Load all dashboard data
        async function loadAllData() {
            await Promise.all([
                loadLeaderboard(),
                loadBirdieLeaders(),
                loadCoursesTable(),
                loadMonthlyTrend()
            ]);
        }

        // 1. Load Season Leaderboard
        async function loadLeaderboard() {
            const { data, error } = await supabase
                .from('player_rounds')
                .select('player_name, final_total, rank, round_id')
                .order('final_total', { ascending: false });

            if (error) {
                document.getElementById('leaderboard').innerHTML = 'Error loading data';
                console.error('Leaderboard error:', error);
                return;
            }

            // Aggregate by player
            const playerStats = {};
            data.forEach(round => {
                if (!playerStats[round.player_name]) {
                    playerStats[round.player_name] = {
                        points: 0,
                        rounds: 0,
                        wins: 0,
                        top3: 0
                    };
                }
                playerStats[round.player_name].points += round.final_total || 0;
                playerStats[round.player_name].rounds += 1;
                if (round.rank === 1) playerStats[round.player_name].wins += 1;
                if (round.rank <= 3) playerStats[round.player_name].top3 += 1;
            });

            // Convert to array and sort by points
            const leaderboard = Object.entries(playerStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.points - a.points);

            // Generate HTML
            let html = `<table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Rounds</th>
                        <th>Points</th>
                        <th>Wins</th>
                        <th>Top 3</th>
                    </tr>
                </thead>
                <tbody>`;
            
            leaderboard.forEach((player, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                html += `<tr>
                    <td><span class="rank-badge ${rankClass}">${index + 1}</span></td>
                    <td><strong>${player.name}</strong></td>
                    <td>${player.rounds}</td>
                    <td><strong>${player.points.toFixed(1)}</strong></td>
                    <td>${player.wins}</td>
                    <td>${player.top3}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('leaderboard').innerHTML = html;
        }

        // 2. Load Ace/Eagle/Birdie Leaders
        async function loadBirdieLeaders() {
            const { data, error } = await supabase
                .from('player_rounds')
                .select('player_name, aces, eagles, birdies');

            if (error) {
                document.getElementById('birdieLeaders').innerHTML = 'Error loading data';
                console.error('Birdie leaders error:', error);
                return;
            }

            // Aggregate by player
            const playerStats = {};
            data.forEach(round => {
                if (!playerStats[round.player_name]) {
                    playerStats[round.player_name] = { aces: 0, eagles: 0, birdies: 0 };
                }
                playerStats[round.player_name].aces += round.aces || 0;
                playerStats[round.player_name].eagles += round.eagles || 0;
                playerStats[round.player_name].birdies += round.birdies || 0;
            });

            // Sort by total (aces + eagles + birdies)
            const sorted = Object.entries(playerStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    total: stats.aces + stats.eagles + stats.birdies
                }))
                .sort((a, b) => b.total - a.total);

            // Find max for scaling the overall bar width
            const maxTotal = Math.max(...sorted.map(p => p.total), 1);

            // Generate HTML with horizontal bars
            let html = '<div style="padding: 10px;">';
            sorted.forEach(player => {
                // Scale the entire bar width based on total compared to max
                const totalWidth = (player.total / maxTotal) * 100;
                
                // Calculate pixel widths for each segment proportionally
                const acePercent = player.total > 0 ? (player.aces / player.total) * 100 : 0;
                const eaglePercent = player.total > 0 ? (player.eagles / player.total) * 100 : 0;
                const birdiePercent = player.total > 0 ? (player.birdies / player.total) * 100 : 0;

                html += `
                    <div class="bar-container">
                        <div class="player-name">${player.name}</div>
                        <div class="bars" style="width: ${totalWidth}%; display: flex;">
                            ${player.aces > 0 ? `<div class="bar bar-ace" style="width: ${acePercent}%;">${player.aces}</div>` : ''}
                            ${player.eagles > 0 ? `<div class="bar bar-eagle" style="width: ${eaglePercent}%;">${player.eagles}</div>` : ''}
                            ${player.birdies > 0 ? `<div class="bar bar-birdie" style="width: ${birdiePercent}%;">${player.birdies}</div>` : ''}
                        </div>
                        <span style="margin-left: 10px; color: #666; font-size: 0.9em;">${player.total}</span>
                    </div>`;
            });
            html += '</div>';
            document.getElementById('birdieLeaders').innerHTML = html;
        }

        // 3. Load Courses Table - Average Score by Course Tiers
        async function loadCoursesTable() {
            // Get all rounds with course multiplier
            const { data: rounds, error: roundsError } = await supabase
                .from('rounds')
                .select('id, course_name, course_multiplier');

            if (roundsError) {
                document.getElementById('coursesTable').innerHTML = 'Error loading data';
                console.error('Courses error:', roundsError);
                return;
            }

            // Get player rounds to calculate average points
            const { data: playerRounds, error: prError } = await supabase
                .from('player_rounds')
                .select('round_id, player_name, final_total');

            if (prError) {
                document.getElementById('coursesTable').innerHTML = 'Error loading data';
                return;
            }

            // Map round_id to course tier
            const roundMap = {};
            rounds.forEach(r => {
                roundMap[r.id] = r.course_multiplier || 1.0;
            });

            // Build data structure: playerStats[playerName][tier] = {total, count}
            const playerStats = {};
            playerRounds.forEach(pr => {
                const tier = roundMap[pr.round_id];
                if (!tier) return;

                if (!playerStats[pr.player_name]) {
                    playerStats[pr.player_name] = {};
                }
                if (!playerStats[pr.player_name][tier]) {
                    playerStats[pr.player_name][tier] = { total: 0, count: 0 };
                }
                playerStats[pr.player_name][tier].total += pr.final_total || 0;
                playerStats[pr.player_name][tier].count += 1;
            });

            // Get all unique tiers and sort
            const allTiers = [...new Set(Object.values(roundMap))].sort((a, b) => b - a);

            // Generate HTML table
            let html = `<table>
                <thead>
                    <tr>
                        <th>Player</th>`;
            
            allTiers.forEach(tier => {
                html += `<th>${tier.toFixed(2)}x</th>`;
            });
            
            html += `</tr>
                </thead>
                <tbody>`;
            
            // Sort players alphabetically
            const sortedPlayers = Object.keys(playerStats).sort();
            
            sortedPlayers.forEach(player => {
                html += `<tr>
                    <td><strong>${player}</strong></td>`;
                
                allTiers.forEach(tier => {
                    const stats = playerStats[player][tier];
                    if (stats) {
                        const avg = stats.total / stats.count;
                        html += `<td>${avg.toFixed(1)}</td>`;
                    } else {
                        html += `<td style="color: #ccc;">-</td>`;
                    }
                });
                
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('coursesTable').innerHTML = html;
        }

        // 4. Load Monthly Points Trend
        async function loadMonthlyTrend() {
            const { data: rounds, error: roundsError } = await supabase
                .from('rounds')
                .select('id, date')
                .order('date', { ascending: true });

            if (roundsError) {
                console.error('Monthly trend error:', roundsError);
                return;
            }

            const { data: playerRounds, error: prError } = await supabase
                .from('player_rounds')
                .select('round_id, player_name, final_total');

            if (prError) {
                console.error('Player rounds error:', prError);
                return;
            }

            // Map rounds to dates
            const roundDateMap = {};
            rounds.forEach(r => {
                roundDateMap[r.id] = r.date;
            });

            // Organize by player and month
            const playerMonthlyData = {};
            playerRounds.forEach(pr => {
                const date = roundDateMap[pr.round_id];
                if (!date) return;

                // Extract year-month
                const month = date.substring(0, 7); // Assumes format YYYY-MM-DD

                if (!playerMonthlyData[pr.player_name]) {
                    playerMonthlyData[pr.player_name] = {};
                }
                if (!playerMonthlyData[pr.player_name][month]) {
                    playerMonthlyData[pr.player_name][month] = 0;
                }
                playerMonthlyData[pr.player_name][month] += pr.final_total || 0;
            });

            // Get all unique months sorted
            const allMonths = [...new Set(Object.values(roundDateMap).map(d => d.substring(0, 7)))].sort();

            // Generate datasets for each player
            const colors = ['#667eea', '#e74c3c', '#27ae60', '#f39c12', '#3498db', '#9b59b6', '#1abc9c', '#e67e22'];
            const datasets = Object.entries(playerMonthlyData).map(([player, months], index) => {
                return {
                    label: player,
                    data: allMonths.map(month => months[month] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.3,
                    fill: false
                };
            });

            const ctx = document.getElementById('monthlyTrendChart');
            if (monthlyTrendChart) monthlyTrendChart.destroy();
            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Points'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // CHAT FUNCTIONALITY
        // ============================================
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            
            if (!question) return;

            // Add user message
            addMessage(question, 'user');
            input.value = '';

            // Disable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            try {
                const response = await fetch(N8N_CHATBOT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();
                addMessage(data.answer || 'Sorry, I could not process that question.', 'bot');
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('Error: Could not connect to chatbot. Make sure n8n is running and the webhook URL is correct.', 'bot');
            }

            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
        }

        function addMessage(text, type) {
            const chatBox = document.getElementById('chatBox');
            const message = document.createElement('div');
            message.className = `message ${type}-message`;
            message.style.whiteSpace = 'pre-wrap';
            message.textContent = text;
            chatBox.appendChild(message);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ============================================
        // INITIALIZE
        // ============================================
        loadAllData();
        
        // Auto-refresh every 5 minutes
        setInterval(loadAllData, 300000);
    </script>
</body>
</html>