<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParSaveables Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', 'Orbitron', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d35 25%, #2d1b3d 50%, #1a1d35 75%, #0a0e27 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 0, 100, 0.15) 0%, rgba(255, 102, 0, 0.15) 50%, rgba(255, 215, 0, 0.15) 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 60px rgba(255, 0, 100, 0.3);
            position: relative;
        }

        h1 {
            font-size: 1.875em;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        /* Back Button */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 0;
            background: linear-gradient(135deg, #0066ff 0%, #00ccff 100%);
            color: white;
            border: 2px solid #64ffda;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
        }

        /* Login Section */
        #loginSection {
            max-width: 500px;
            margin: 100px auto;
            background: rgba(20, 25, 45, 0.9);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 102, 0, 0.4);
            border: 2px solid rgba(255, 102, 0, 0.3);
        }

        #loginSection h2 {
            color: #ff6600;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #64ffda;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(100, 255, 218, 0.3);
            background: rgba(10, 14, 39, 0.8);
            color: #ffffff;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.4);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff0064 0%, #ff6600 100%);
            color: white;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.6);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.8);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0066ff 0%, #00ccff 100%);
            color: white;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        }

        /* Admin Content */
        #adminContent {
            display: none;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .tab-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: 2px solid rgba(255, 102, 0, 0.4);
            background: rgba(20, 25, 45, 0.8);
            color: #ffd700;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-btn.active {
            border-color: #ff6600;
            background: linear-gradient(135deg, #ff0064 0%, #ff6600 100%);
            color: white;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.6);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: rgba(20, 25, 45, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 102, 0, 0.4);
            border: 2px solid rgba(255, 102, 0, 0.3);
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2 {
            color: #ff6600;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(10, 14, 39, 0.6);
            border-radius: 12px;
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table th {
            background: linear-gradient(135deg, rgba(255, 0, 100, 0.3) 0%, rgba(255, 102, 0, 0.3) 100%);
            padding: 15px;
            text-align: left;
            color: #ffd700;
            font-weight: bold;
            border-bottom: 2px solid rgba(255, 102, 0, 0.4);
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            color: #e6f1ff;
        }

        .data-table tr:hover {
            background: rgba(100, 255, 218, 0.05);
        }

        .data-table button {
            margin-right: 8px;
            padding: 6px 12px;
            font-size: 0.9em;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(26, 29, 53, 0.98) 0%, rgba(45, 27, 61, 0.98) 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 60px rgba(255, 102, 0, 0.6);
            border: 2px solid rgba(255, 102, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #ff6600;
            font-size: 1.8em;
        }

        .close-btn {
            background: none;
            border: none;
            color: #ff6600;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 102, 0, 0.2);
        }

        /* JSON Editor */
        .json-editor {
            width: 100%;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(100, 255, 218, 0.3);
            background: rgba(10, 14, 39, 0.8);
            color: #64ffda;
        }

        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success {
            background: rgba(0, 255, 100, 0.2);
            border: 2px solid rgba(0, 255, 100, 0.4);
            color: #00ff64;
        }

        .alert-error {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.4);
            color: #ff6666;
        }

        .alert-info {
            background: rgba(0, 204, 255, 0.2);
            border: 2px solid rgba(0, 204, 255, 0.4);
            color: #00ccff;
        }

        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ff6600;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                background-attachment: scroll;
                position: relative;
                overflow-x: hidden;
            }

            h1 {
                font-size: 1.4em;
            }

            .back-btn {
                position: absolute;
                top: 20px;
                left: 20px;
            }

            header .btn-danger {
                position: absolute;
                top: 20px;
                right: 20px;
            }

            .tab-nav {
                flex-direction: column;
            }

            .tab-content {
                padding: 15px;
            }

            .data-table {
                font-size: 0.75em;
                display: block;
                overflow-x: auto;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            .data-table button {
                padding: 4px 8px;
                font-size: 0.85em;
                margin-right: 4px;
            }

            .modal-content {
                padding: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection">
            <h2>üîê Admin Login</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="admin@parsaveables.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
            <div id="loginError" style="margin-top: 15px;"></div>
        </div>

        <!-- Admin Content -->
        <div id="adminContent">
            <header>
                <button class="back-btn" onclick="window.location.href='index.html'">‚Üê</button>
                <h1>‚öôÔ∏è Control Panel</h1>
                <button class="btn btn-danger" onclick="logout()" style="position: absolute; top: 20px; right: 20px; padding: 0; font-size: 0.9em; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">‚èª</button>
            </header>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchAdminTab('pointsSystems')">Points Systems</button>
                <button class="tab-btn" onclick="switchAdminTab('courses')">Courses</button>
                <button class="tab-btn" onclick="switchAdminTab('events')">Events</button>
                <button class="tab-btn" onclick="switchAdminTab('data')">Data Import/Export</button>
                <button class="tab-btn" onclick="switchAdminTab('users')">User Management</button>
            </div>

            <!-- Points Systems Tab -->
            <div id="pointsSystemsTab" class="tab-content active">
                <h2>üìä Points Systems Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openPointsSystemModal()">+ Create New Points System</button>
                    <button class="btn btn-secondary" onclick="loadPointsSystems()">üîÑ Refresh</button>
                </div>
                <div id="pointsSystemsList"></div>
            </div>

            <!-- Courses Tab -->
            <div id="coursesTab" class="tab-content">
                <h2>üèûÔ∏è Courses Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openCourseModal()">+ Add New Course</button>
                    <button class="btn btn-secondary" onclick="loadCourses()">üîÑ Refresh</button>
                </div>
                <div id="coursesList"></div>
            </div>

            <!-- Events Tab -->
            <div id="eventsTab" class="tab-content">
                <h2>üèÜ Events Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openEventModal()">+ Create New Event</button>
                    <button class="btn btn-secondary" onclick="loadEvents()">üîÑ Refresh</button>
                </div>
                <div id="eventsList"></div>
            </div>

            <!-- Data Import/Export Tab -->
            <div id="dataTab" class="tab-content">
                <h2>üíæ Data Import/Export</h2>

                <div style="margin-bottom: 30px;">
                    <h3 style="color: #64ffda; margin-bottom: 15px;">Export Data</h3>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="exportData('points_systems')">Export Points Systems</button>
                        <button class="btn btn-secondary" onclick="exportData('courses')">Export Courses</button>
                        <button class="btn btn-secondary" onclick="exportData('events')">Export Events</button>
                        <button class="btn btn-secondary" onclick="exportData('rounds')">Export Rounds</button>
                        <button class="btn btn-secondary" onclick="exportData('player_rounds')">Export Player Rounds</button>
                        <button class="btn btn-primary" onclick="exportAllData()">üì¶ Export All Data</button>
                    </div>
                </div>

                <div>
                    <h3 style="color: #64ffda; margin-bottom: 15px;">Import Data</h3>
                    <div class="alert alert-info">
                        Upload CSV or JSON files to import data. Make sure the file format matches the table structure.
                    </div>
                    <div class="form-group">
                        <label>Select Table</label>
                        <select id="importTable">
                            <option value="points_systems">Points Systems</option>
                            <option value="courses">Courses</option>
                            <option value="events">Events</option>
                            <option value="rounds">Rounds</option>
                            <option value="player_rounds">Player Rounds</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload File (JSON or CSV)</label>
                        <input type="file" id="importFile" accept=".json,.csv">
                    </div>
                    <button class="btn btn-primary" onclick="importData()">üì• Import Data</button>
                </div>

                <div id="importExportStatus" style="margin-top: 20px;"></div>
            </div>

            <!-- User Management Tab -->
            <div id="usersTab" class="tab-content">
                <h2>üë• User Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openInviteUserModal()">+ Invite Admin User</button>
                    <button class="btn btn-secondary" onclick="loadUsers()">üîÑ Refresh</button>
                </div>
                <div id="usersList"></div>
            </div>
        </div>
    </div>

    <!-- Points System Modal -->
    <div id="pointsSystemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="pointsSystemModalTitle">Create Points System</h3>
                <button class="close-btn" onclick="closePointsSystemModal()">√ó</button>
            </div>
            <form id="pointsSystemForm">
                <input type="hidden" id="pointsSystemId">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="pointsSystemName" required placeholder="e.g., Season 2026">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="pointsSystemDescription" rows="2" placeholder="Brief description of this points system"></textarea>
                </div>
                <div class="form-group">
                    <label>Configuration (JSON) *</label>
                    <textarea class="json-editor" id="pointsSystemConfig" rows="15" required>{
  "rank_points": {
    "1": 10,
    "2": 7,
    "3": 5,
    "default": 2
  },
  "performance_points": {
    "birdie": 1,
    "eagle": 3,
    "ace": 5
  },
  "tie_breaking": {
    "enabled": true,
    "method": "average"
  },
  "course_multiplier": {
    "enabled": true,
    "source": "course_tier"
  }
}</textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn btn-primary">Save Points System</button>
                    <button type="button" class="btn btn-secondary" onclick="closePointsSystemModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Course Modal -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="courseModalTitle">Add Course</h3>
                <button class="close-btn" onclick="closeCourseModal()">√ó</button>
            </div>
            <form id="courseForm">
                <input type="hidden" id="courseId">
                <div class="form-group">
                    <label>Course Name *</label>
                    <input type="text" id="courseName" required placeholder="e.g., Zilker Park">
                </div>
                <div class="form-group">
                    <label>Tier *</label>
                    <select id="courseTier" required>
                        <option value="1">Tier 1 - Beginner</option>
                        <option value="2">Tier 2 - Intermediate</option>
                        <option value="3">Tier 3 - Advanced</option>
                        <option value="4">Tier 4 - Expert</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Multiplier *</label>
                    <input type="number" id="courseMultiplier" step="0.1" min="1.0" max="5.0" required placeholder="e.g., 1.5">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="courseActive" checked> Active
                    </label>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn btn-primary">Save Course</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCourseModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="eventModalTitle">Create Event</h3>
                <button class="close-btn" onclick="closeEventModal()">√ó</button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventId">
                <div class="form-group">
                    <label>Event Name *</label>
                    <input type="text" id="eventName" required placeholder="e.g., 2026 or Summer Tournament">
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="eventType" required>
                        <option value="season">Season</option>
                        <option value="tournament">Tournament</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year *</label>
                    <input type="number" id="eventYear" required min="2020" max="2100" placeholder="e.g., 2026">
                </div>
                <div class="form-group">
                    <label>Start Date *</label>
                    <input type="date" id="eventStartDate" required>
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="eventEndDate">
                </div>
                <div class="form-group">
                    <label>Points System *</label>
                    <select id="eventPointsSystem" required>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="eventActive" checked> Active
                    </label>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn btn-primary">Save Event</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEventModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invite User Modal -->
    <div id="inviteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Invite Admin User</h3>
                <button class="close-btn" onclick="closeInviteUserModal()">√ó</button>
            </div>
            <form id="inviteUserForm">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="inviteUserEmail" required placeholder="newadmin@example.com">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="inviteUserRole">
                        <option value="admin">Admin</option>
                        <option value="super_admin">Super Admin</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    An invitation email will be sent to the user to set up their password.
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                    <button type="button" class="btn btn-secondary" onclick="closeInviteUserModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================

        const SUPABASE_URL = 'https://bcovevbtcdsgzbrieiin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjb3ZldmJ0Y2RzZ3picmllaWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzA3OTEsImV4cCI6MjA3NjIwNjc5MX0.etzrLL8yw4n_NUdYnr_bdcrKphW67dYln8CjR54NSLA';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================================================
        // AUTHENTICATION
        // ============================================================================

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Show admin content
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';

                // Load initial data
                loadPointsSystems();
            } catch (error) {
                errorDiv.innerHTML = `<div class="alert alert-error">Login failed: ${error.message}</div>`;
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Check if user is already logged in
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadPointsSystems();
            }
        });

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================

        function switchAdminTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for the tab
            switch(tabName) {
                case 'pointsSystems':
                    loadPointsSystems();
                    break;
                case 'courses':
                    loadCourses();
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }

        // ============================================================================
        // POINTS SYSTEMS MANAGEMENT
        // ============================================================================

        async function loadPointsSystems() {
            const container = document.getElementById('pointsSystemsList');
            container.innerHTML = '<div class="loading"></div> Loading points systems...';

            try {
                const { data, error } = await supabase
                    .from('points_systems')
                    .select('*')
                    .order('id', { ascending: true });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No points systems found. Create one to get started!</div>';
                    return;
                }

                let html = '<table class="data-table">';
                html += '<thead><tr><th>Name</th><th>Actions</th></tr></thead>';
                html += '<tbody>';

                data.forEach(ps => {
                    html += `<tr>
                        <td><strong>${ps.name}</strong></td>
                        <td>
                            <button class="btn btn-secondary" onclick='editPointsSystem(${JSON.stringify(ps)})'>Edit</button>
                            <button class="btn btn-danger" onclick="deletePointsSystem(${ps.id}, '${ps.name}')">Delete</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Error loading points systems: ${error.message}</div>`;
            }
        }

        function openPointsSystemModal(ps = null) {
            document.getElementById('pointsSystemModal').classList.add('active');

            if (ps) {
                document.getElementById('pointsSystemModalTitle').textContent = 'Edit Points System';
                document.getElementById('pointsSystemId').value = ps.id;
                document.getElementById('pointsSystemName').value = ps.name;
                document.getElementById('pointsSystemDescription').value = ps.description || '';
                document.getElementById('pointsSystemConfig').value = JSON.stringify(ps.config, null, 2);
            } else {
                document.getElementById('pointsSystemModalTitle').textContent = 'Create Points System';
                document.getElementById('pointsSystemForm').reset();
                document.getElementById('pointsSystemId').value = '';
            }
        }

        function closePointsSystemModal() {
            document.getElementById('pointsSystemModal').classList.remove('active');
        }

        function editPointsSystem(ps) {
            openPointsSystemModal(ps);
        }

        document.getElementById('pointsSystemForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('pointsSystemId').value;
            const name = document.getElementById('pointsSystemName').value;
            const description = document.getElementById('pointsSystemDescription').value;
            const configText = document.getElementById('pointsSystemConfig').value;

            try {
                const config = JSON.parse(configText);

                const data = {
                    name: name,
                    description: description,
                    config: config
                };

                if (id) {
                    // Update
                    const { error } = await supabase
                        .from('points_systems')
                        .update(data)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Points system updated successfully!');
                } else {
                    // Insert
                    const { error } = await supabase
                        .from('points_systems')
                        .insert([data]);

                    if (error) throw error;
                    alert('Points system created successfully!');
                }

                closePointsSystemModal();
                loadPointsSystems();
            } catch (error) {
                alert('Error saving points system: ' + error.message);
            }
        });

        async function deletePointsSystem(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"? This may affect events using this points system.`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('points_systems')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Points system deleted successfully!');
                loadPointsSystems();
            } catch (error) {
                alert('Error deleting points system: ' + error.message);
            }
        }

        // ============================================================================
        // COURSES MANAGEMENT
        // ============================================================================

        async function loadCourses() {
            const container = document.getElementById('coursesList');
            container.innerHTML = '<div class="loading"></div> Loading courses...';

            try {
                const { data, error } = await supabase
                    .from('courses')
                    .select('*')
                    .order('tier', { ascending: true })
                    .order('course_name', { ascending: true });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No courses found. Add one to get started!</div>';
                    return;
                }

                let html = '<table class="data-table">';
                html += '<thead><tr><th>Course Name</th><th>Tier</th><th>Multiplier</th><th>Actions</th></tr></thead>';
                html += '<tbody>';

                data.forEach(course => {
                    const tierName = ['', 'Beginner', 'Intermediate', 'Advanced', 'Expert'][course.tier];
                    html += `<tr>
                        <td><strong>${course.course_name}</strong></td>
                        <td>Tier ${course.tier} - ${tierName}</td>
                        <td>${course.multiplier}x</td>
                        <td>
                            <button class="btn btn-secondary" onclick='editCourse(${JSON.stringify(course)})'>Edit</button>
                            <button class="btn btn-danger" onclick="deleteCourse(${course.id}, '${course.course_name}')">Delete</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Error loading courses: ${error.message}</div>`;
            }
        }

        function openCourseModal(course = null) {
            document.getElementById('courseModal').classList.add('active');

            if (course) {
                document.getElementById('courseModalTitle').textContent = 'Edit Course';
                document.getElementById('courseId').value = course.id;
                document.getElementById('courseName').value = course.course_name;
                document.getElementById('courseTier').value = course.tier;
                document.getElementById('courseMultiplier').value = course.multiplier;
                document.getElementById('courseActive').checked = course.active;
            } else {
                document.getElementById('courseModalTitle').textContent = 'Add Course';
                document.getElementById('courseForm').reset();
                document.getElementById('courseId').value = '';
            }
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function editCourse(course) {
            openCourseModal(course);
        }

        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('courseId').value;
            const data = {
                course_name: document.getElementById('courseName').value,
                tier: parseInt(document.getElementById('courseTier').value),
                multiplier: parseFloat(document.getElementById('courseMultiplier').value),
                active: document.getElementById('courseActive').checked
            };

            try {
                if (id) {
                    // Update
                    const { error } = await supabase
                        .from('courses')
                        .update(data)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Course updated successfully!');
                } else {
                    // Insert
                    const { error } = await supabase
                        .from('courses')
                        .insert([data]);

                    if (error) throw error;
                    alert('Course added successfully!');
                }

                closeCourseModal();
                loadCourses();
            } catch (error) {
                alert('Error saving course: ' + error.message);
            }
        });

        async function deleteCourse(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('courses')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Course deleted successfully!');
                loadCourses();
            } catch (error) {
                alert('Error deleting course: ' + error.message);
            }
        }

        // ============================================================================
        // EVENTS MANAGEMENT
        // ============================================================================

        async function loadEvents() {
            const container = document.getElementById('eventsList');
            container.innerHTML = '<div class="loading"></div> Loading events...';

            try {
                const { data, error } = await supabase
                    .from('events')
                    .select(`
                        *,
                        points_systems (name)
                    `)
                    .order('year', { ascending: false })
                    .order('start_date', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No events found. Create one to get started!</div>';
                    return;
                }

                let html = '<table class="data-table">';
                html += '<thead><tr><th>Name</th><th>Type</th><th>Year</th><th>Actions</th></tr></thead>';
                html += '<tbody>';

                data.forEach(event => {
                    const typeIcon = event.type === 'season' ? 'üèÜ' : 'üéØ';
                    html += `<tr>
                        <td><strong>${event.name}</strong></td>
                        <td>${typeIcon} ${event.type}</td>
                        <td>${event.year}</td>
                        <td>
                            <button class="btn btn-secondary" onclick='editEvent(${JSON.stringify(event).replace(/'/g, "\\'")})'>Edit</button>
                            <button class="btn btn-danger" onclick="deleteEvent(${event.id}, '${event.name}')">Delete</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Error loading events: ${error.message}</div>`;
            }
        }

        async function openEventModal(event = null) {
            document.getElementById('eventModal').classList.add('active');

            // Load points systems for dropdown
            const { data: pointsSystems } = await supabase
                .from('points_systems')
                .select('id, name')
                .order('name', { ascending: true });

            const select = document.getElementById('eventPointsSystem');
            select.innerHTML = pointsSystems.map(ps =>
                `<option value="${ps.id}">${ps.name}</option>`
            ).join('');

            if (event) {
                document.getElementById('eventModalTitle').textContent = 'Edit Event';
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventName').value = event.name;
                document.getElementById('eventType').value = event.type;
                document.getElementById('eventYear').value = event.year;
                document.getElementById('eventStartDate').value = event.start_date;
                document.getElementById('eventEndDate').value = event.end_date || '';
                document.getElementById('eventPointsSystem').value = event.points_system_id;
                document.getElementById('eventActive').checked = event.is_active;
            } else {
                document.getElementById('eventModalTitle').textContent = 'Create Event';
                document.getElementById('eventForm').reset();
                document.getElementById('eventId').value = '';
                document.getElementById('eventYear').value = new Date().getFullYear();
            }
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        function editEvent(event) {
            openEventModal(event);
        }

        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('eventId').value;
            const data = {
                name: document.getElementById('eventName').value,
                type: document.getElementById('eventType').value,
                year: parseInt(document.getElementById('eventYear').value),
                start_date: document.getElementById('eventStartDate').value,
                end_date: document.getElementById('eventEndDate').value || null,
                points_system_id: parseInt(document.getElementById('eventPointsSystem').value),
                is_active: document.getElementById('eventActive').checked
            };

            try {
                if (id) {
                    // Update
                    const { error } = await supabase
                        .from('events')
                        .update(data)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Event updated successfully!');
                } else {
                    // Insert
                    const { error } = await supabase
                        .from('events')
                        .insert([data]);

                    if (error) throw error;
                    alert('Event created successfully!');
                }

                closeEventModal();
                loadEvents();
            } catch (error) {
                alert('Error saving event: ' + error.message);
            }
        });

        async function deleteEvent(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"? This will also delete all associated rounds!`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Event deleted successfully!');
                loadEvents();
            } catch (error) {
                alert('Error deleting event: ' + error.message);
            }
        }

        // ============================================================================
        // DATA IMPORT/EXPORT
        // ============================================================================

        async function exportData(tableName) {
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*');

                if (error) throw error;

                // Convert to JSON and download
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tableName}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                document.getElementById('importExportStatus').innerHTML =
                    `<div class="alert alert-success">Exported ${data.length} rows from ${tableName}</div>`;
            } catch (error) {
                document.getElementById('importExportStatus').innerHTML =
                    `<div class="alert alert-error">Export failed: ${error.message}</div>`;
            }
        }

        async function exportAllData() {
            const tables = ['points_systems', 'courses', 'events', 'rounds', 'player_rounds'];
            const allData = {};

            try {
                for (const table of tables) {
                    const { data, error } = await supabase.from(table).select('*');
                    if (error) throw error;
                    allData[table] = data;
                }

                const jsonStr = JSON.stringify(allData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `parsaveables_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                document.getElementById('importExportStatus').innerHTML =
                    `<div class="alert alert-success">Full database backup created successfully!</div>`;
            } catch (error) {
                document.getElementById('importExportStatus').innerHTML =
                    `<div class="alert alert-error">Export failed: ${error.message}</div>`;
            }
        }

        async function importData() {
            const table = document.getElementById('importTable').value;
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file to import');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    let data;
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        // Simple CSV parsing (you may want to use a library for complex CSVs)
                        const lines = e.target.result.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        data = lines.slice(1).map(line => {
                            const values = line.split(',');
                            const obj = {};
                            headers.forEach((header, i) => {
                                obj[header] = values[i]?.trim();
                            });
                            return obj;
                        }).filter(obj => Object.keys(obj).length > 0);
                    } else {
                        throw new Error('Unsupported file format');
                    }

                    const { error } = await supabase
                        .from(table)
                        .insert(data);

                    if (error) throw error;

                    document.getElementById('importExportStatus').innerHTML =
                        `<div class="alert alert-success">Imported ${data.length} rows into ${table}</div>`;

                    fileInput.value = '';
                } catch (error) {
                    document.getElementById('importExportStatus').innerHTML =
                        `<div class="alert alert-error">Import failed: ${error.message}</div>`;
                }
            };
            reader.readAsText(file);
        }

        // ============================================================================
        // USER MANAGEMENT
        // ============================================================================

        async function loadUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '<div class="alert alert-info">User management requires Supabase Auth Admin API. This is a placeholder for the feature.</div>';

            // In a production environment, you would use Supabase Auth Admin API
            // to list users, which requires a service role key (not the anon key)
            // For security, this should be done through a backend API endpoint
        }

        function openInviteUserModal() {
            document.getElementById('inviteUserModal').classList.add('active');
        }

        function closeInviteUserModal() {
            document.getElementById('inviteUserModal').classList.remove('active');
        }

        document.getElementById('inviteUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('inviteUserEmail').value;
            const role = document.getElementById('inviteUserRole').value;

            // In production, you would call a backend API endpoint that uses
            // the Supabase Admin API to create/invite users
            alert(`Feature coming soon! Would invite ${email} as ${role}`);
            closeInviteUserModal();
        });
    </script>
</body>
</html>
