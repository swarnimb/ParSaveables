<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParSaveables Disc Golf Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1920&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 100vh;
            padding: 20px;
            color: #e6f1ff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: #64ffda;
            margin-bottom: 30px;
            position: relative;
            background: rgba(10, 20, 35, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(100, 255, 218, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .logo-container {
            display: inline-block;
            position: relative;
            margin-bottom: 15px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            filter: drop-shadow(0 4px 8px rgba(100, 255, 218, 0.4));
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(100, 255, 218, 0.5), 0 0 40px rgba(100, 255, 218, 0.3);
            font-weight: 700;
            letter-spacing: 2px;
        }
        
        
        .chat-section {
            background: rgba(10, 20, 35, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            margin-bottom: 25px;
            margin-left: auto;
            margin-right: auto;
            max-width: 800px;
            border: 1px solid rgba(100, 255, 218, 0.2);
            transition: all 0.3s ease;
            min-height: auto;
            display: flex;
            flex-direction: column;
        }

        .chat-section.expanded {
            padding: 20px;
            min-height: 450px;
        }

        .chat-box {
            height: 0;
            overflow: hidden;
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 10px;
            padding: 0;
            margin-bottom: 0;
            background: rgba(10, 25, 47, 0.6);
            transition: all 0.3s ease;
        }

        .chat-box.visible {
            height: 350px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            animation: fadeIn 0.3s;
            font-size: 0.9em;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, #64ffda 0%, #00d9ff 100%);
            color: #0a192f;
            margin-left: auto;
            text-align: right;
            font-weight: 500;
        }
        
        .bot-message {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid rgba(100, 255, 218, 0.2);
            color: #e6f1ff;
            white-space: pre-wrap;
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
        }
        
        #chatInput {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 8px;
            font-size: 0.9em;
            background: rgba(10, 25, 47, 0.6);
            color: #e6f1ff;
        }
        
        #chatInput::placeholder {
            color: rgba(230, 241, 255, 0.5);
        }
        
        #sendBtn {
            background: linear-gradient(135deg, #64ffda 0%, #00d9ff 100%);
            color: #0a192f;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(100, 255, 218, 0.4);
        }
        
        #sendBtn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .row {
            margin-bottom: 20px;
        }
        
        .row-1 {
            display: grid;
            grid-template-columns: 1fr;
        }
        
        .row-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .row-3 {
            display: grid;
            grid-template-columns: 1fr;
        }
        
        .card {
            background: rgba(10, 20, 35, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(100, 255, 218, 0.2);
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }
        
        .card h2 {
            color: #64ffda;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(100, 255, 218, 0.3);
            padding-bottom: 10px;
            text-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
        }
        
        .scrollable-table {
            max-height: 350px;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 8px;
            flex-grow: 1;
        }
        
        .scrollable-table::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .scrollable-table::-webkit-scrollbar-track {
            background: rgba(100, 255, 218, 0.1);
            border-radius: 4px;
        }
        
        .scrollable-table::-webkit-scrollbar-thumb {
            background: rgba(100, 255, 218, 0.3);
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
        }
        
        th {
            background: rgba(100, 255, 218, 0.1);
            font-weight: 600;
            color: #64ffda;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: rgba(100, 255, 218, 0.05);
        }
        
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
        }
        
        .rank-1 { 
            background: linear-gradient(135deg, #64ffda 0%, #00d9ff 100%);
            color: #0a192f;
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.5);
        }
        .rank-2 { 
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #0a192f;
        }
        .rank-3 { 
            background: linear-gradient(135deg, #cd7f32 0%, #e39a5a 100%);
            color: white;
        }
        .rank-other { 
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
        }
        
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .player-name {
            min-width: 120px;
            font-weight: 600;
            color: #64ffda;
        }
        
        .bars {
            display: flex;
            flex: 1;
            gap: 2px;
            height: 25px;
        }
        
        .bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            border-radius: 3px;
        }
        
        .bar-ace { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .bar-eagle { background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); }
        .bar-birdie { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        
        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .loading {
            text-align: center;
            color: #64ffda;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header h1 {
                font-size: 1.8em;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .row-2 {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 15px;
            }
            
            .card h2 {
                font-size: 1.1em;
            }
            
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 8px;
            }
            
            .player-name {
                min-width: 80px;
                font-size: 0.85em;
            }
            
            .chat-box.visible {
                height: 120px;
            }
        }
        
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5em;
            }
            
            table {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <ellipse cx="50" cy="70" rx="25" ry="8" fill="#444" opacity="0.6"/>
                    <rect x="48" y="30" width="4" height="40" fill="#666"/>
                    <circle cx="50" cy="30" r="2" fill="#888"/>
                    <line x1="35" y1="35" x2="35" y2="65" stroke="#888" stroke-width="1"/>
                    <line x1="42" y1="32" x2="42" y2="65" stroke="#888" stroke-width="1"/>
                    <line x1="50" y1="30" x2="50" y2="65" stroke="#888" stroke-width="1"/>
                    <line x1="58" y1="32" x2="58" y2="65" stroke="#888" stroke-width="1"/>
                    <line x1="65" y1="35" x2="65" y2="65" stroke="#888" stroke-width="1"/>
                    <g transform="translate(50, 15) rotate(15) translate(-50, -15)">
                        <path d="M 35 20 L 40 10 L 45 20 L 50 8 L 55 20 L 60 10 L 65 20 L 65 28 L 35 28 Z" 
                              fill="#64ffda" stroke="#00a896" stroke-width="1.5"/>
                        <circle cx="40" cy="10" r="2" fill="#ff6b6b"/>
                        <circle cx="50" cy="8" r="2.5" fill="#ff6b6b"/>
                        <circle cx="60" cy="10" r="2" fill="#ff6b6b"/>
                    </g>
                </svg>
            </div>
            <h1>⛓️ ParSaveables Disc Golf Tracker ⛓️</h1>
            <div style="margin: 15px 0;">
                <label for="seasonSelect" style="font-size: 1.1em; margin-right: 10px;">Season:</label>
                <select id="seasonSelect" onchange="loadAllData()" style="padding: 8px 15px; font-size: 1em; border-radius: 5px; background: white; color: #0a192f; border: 2px solid #64ffda; cursor: pointer;">
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
        </header>

        <div class="chat-section" id="chatSection">
            <div class="chat-box" id="chatBox"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask a question about stats..." onkeypress="handleKeyPress(event)">
                <button id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div class="row row-1">
            <div class="card">
                <h2>🏆 Season Leaderboard</h2>
                <div class="scrollable-table">
                    <div id="leaderboard" class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <div class="row row-2">
            <div class="card">
                <h2>🎯 Aces/Eagles/Birdies</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color bar-ace"></div>
                        <span>Aces</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color bar-eagle"></div>
                        <span>Eagles</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color bar-birdie"></div>
                        <span>Birdies</span>
                    </div>
                </div>
                <div class="scrollable-table">
                    <div id="birdieLeaders" class="loading">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h2>🏞️ Average Score by Course Tiers</h2>
                <div class="scrollable-table">
                    <div id="coursesTable" class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <div class="row row-3">
            <div class="card">
                <h2>📈 Monthly Points Trend</h2>
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bcovevbtcdsgzbrieiin.supabase.co';  // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjb3ZldmJ0Y2RzZ3picmllaWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzA3OTEsImV4cCI6MjA3NjIwNjc5MX0.etzrLL8yw4n_NUdYnr_bdcrKphW67dYln8CjR54NSLA';  // Long string starting with 'eyJ...'
        const N8N_CHATBOT_URL = 'https://parsaveables-seasons.onrender.com/webhook/chatbot';  // e.g., 'http://localhost:5678/webhook/chatbot'

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let monthlyTrendChart;
        let availableSeasons = [];

        // Registered players list
        const REGISTERED_PLAYERS = [
            'Intern Line Cook',
            'Jabba the Putt',
            'Food Zaddy',
            'Jaguar',
            'Shogun',
            'BigBirdie',
            'Butter Cookie',
            'Cobra',
            '🦅',
            'Fireball',
            'Ace Brook',
            'ScarletSpeedster'
        ];

        // Get selected season from dropdown
        function getSelectedSeason() {
            const select = document.getElementById('seasonSelect');
            return select.value ? parseInt(select.value) : null;
        }

        // Load available seasons and populate dropdown
        async function loadSeasons() {
            const { data, error } = await supabase
                .from('rounds')
                .select('season')
                .order('season', { ascending: false });

            if (error) {
                console.error('Error loading seasons:', error);
                return;
            }

            // Get unique seasons
            const seasons = [...new Set(data.map(r => r.season))].filter(s => s != null);
            availableSeasons = seasons.sort((a, b) => b - a); // Descending order

            // Populate dropdown
            const select = document.getElementById('seasonSelect');
            select.innerHTML = '';
            availableSeasons.forEach(season => {
                const option = document.createElement('option');
                option.value = season;
                option.textContent = season;
                select.appendChild(option);
            });

            // Select most recent season by default
            if (availableSeasons.length > 0) {
                select.value = availableSeasons[0];
            }
        }

        async function loadAllData() {
            await Promise.all([
                loadLeaderboard(),
                loadBirdieLeaders(),
                loadCoursesTable(),
                loadMonthlyTrend()
            ]);
        }

        async function loadLeaderboard() {
            const selectedSeason = getSelectedSeason();
            if (!selectedSeason) return;

            // Get rounds for selected season
            const { data: rounds, error: roundsError } = await supabase
                .from('rounds')
                .select('id')
                .eq('season', selectedSeason);

            if (roundsError) {
                document.getElementById('leaderboard').innerHTML = 'Error loading data';
                console.error('Rounds error:', roundsError);
                return;
            }

            const roundIds = rounds.map(r => r.id);
            if (roundIds.length === 0) {
                document.getElementById('leaderboard').innerHTML = '<p style="text-align: center; padding: 20px;">No data for this season</p>';
                return;
            }

            // Get player_rounds for these rounds
            const { data, error } = await supabase
                .from('player_rounds')
                .select('player_name, final_total, rank, round_id')
                .in('round_id', roundIds);

            if (error) {
                document.getElementById('leaderboard').innerHTML = 'Error loading data';
                console.error('Leaderboard error:', error);
                return;
            }

            // Filter for registered players only and collect all their rounds
            const playerRounds = {};
            data.forEach(round => {
                // Only count registered players
                if (!REGISTERED_PLAYERS.includes(round.player_name)) return;

                if (!playerRounds[round.player_name]) {
                    playerRounds[round.player_name] = [];
                }
                playerRounds[round.player_name].push({
                    points: round.final_total || 0,
                    rank: round.rank
                });
            });

            // Calculate stats using only TOP 10 scores
            const playerStats = {};
            Object.entries(playerRounds).forEach(([name, rounds]) => {
                // Sort rounds by points (descending) and take top 10
                const sortedRounds = rounds.sort((a, b) => b.points - a.points);
                const top10Rounds = sortedRounds.slice(0, 10);

                playerStats[name] = {
                    points: top10Rounds.reduce((sum, r) => sum + r.points, 0),
                    rounds: rounds.length, // Total rounds played
                    countedRounds: top10Rounds.length, // Rounds counted (max 10)
                    wins: rounds.filter(r => r.rank === 1).length,
                    top3: rounds.filter(r => r.rank <= 3).length
                };
            });

            // SORT BY POINTS (descending)
            const leaderboard = Object.entries(playerStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.points - a.points);

            let html = `<table><thead><tr><th>Rank</th><th>Player</th><th>Played</th><th>Counted</th><th>Points</th><th>Wins</th><th>Top 3</th></tr></thead><tbody>`;

            leaderboard.forEach((player, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                html += `<tr>
                    <td><span class="rank-badge ${rankClass}">${index + 1}</span></td>
                    <td><strong>${player.name}</strong></td>
                    <td>${player.rounds}</td>
                    <td>${player.countedRounds}</td>
                    <td><strong>${player.points.toFixed(1)}</strong></td>
                    <td>${player.wins}</td>
                    <td>${player.top3}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('leaderboard').innerHTML = html;
        }

        async function loadBirdieLeaders() {
            const selectedSeason = getSelectedSeason();
            if (!selectedSeason) return;

            // Get rounds for selected season
            const { data: rounds, error: roundsError } = await supabase
                .from('rounds')
                .select('id')
                .eq('season', selectedSeason);

            if (roundsError) {
                document.getElementById('birdieLeaders').innerHTML = 'Error loading data';
                return;
            }

            const roundIds = rounds.map(r => r.id);
            if (roundIds.length === 0) {
                document.getElementById('birdieLeaders').innerHTML = '<p style="text-align: center; padding: 20px;">No data for this season</p>';
                return;
            }

            const { data, error } = await supabase
                .from('player_rounds')
                .select('player_name, aces, eagles, birdies')
                .in('round_id', roundIds);

            if (error) {
                document.getElementById('birdieLeaders').innerHTML = 'Error loading data';
                return;
            }

            const playerStats = {};
            data.forEach(round => {
                // Only count registered players
                if (!REGISTERED_PLAYERS.includes(round.player_name)) return;

                if (!playerStats[round.player_name]) {
                    playerStats[round.player_name] = { aces: 0, eagles: 0, birdies: 0 };
                }
                playerStats[round.player_name].aces += round.aces || 0;
                playerStats[round.player_name].eagles += round.eagles || 0;
                playerStats[round.player_name].birdies += round.birdies || 0;
            });

            // SORT BY TOTAL (descending)
            const sorted = Object.entries(playerStats)
                .map(([name, stats]) => ({ name, ...stats, total: stats.aces + stats.eagles + stats.birdies }))
                .sort((a, b) => b.total - a.total);

            const maxTotal = Math.max(...sorted.map(p => p.total), 1);

            let html = '<div style="padding: 10px;">';
            sorted.forEach(player => {
                const containerWidth = (player.total / maxTotal) * 100;
                html += `<div class="bar-container"><div class="player-name">${player.name}</div><div style="display: flex; align-items: center; flex: 1;"><div class="bars" style="width: ${containerWidth}%; max-width: 100%; display: flex; gap: 0;">`;
                if (player.aces > 0) html += `<div class="bar bar-ace" style="width: ${(player.aces / player.total) * 100}%; min-width: 30px;">${player.aces}</div>`;
                if (player.eagles > 0) html += `<div class="bar bar-eagle" style="width: ${(player.eagles / player.total) * 100}%; min-width: 30px;">${player.eagles}</div>`;
                if (player.birdies > 0) html += `<div class="bar bar-birdie" style="width: ${(player.birdies / player.total) * 100}%; min-width: 30px;">${player.birdies}</div>`;
                html += `</div><span style="margin-left: 10px; color: #64ffda; font-size: 0.9em; white-space: nowrap;">${player.total}</span></div></div>`;
            });
            html += '</div>';
            document.getElementById('birdieLeaders').innerHTML = html;
        }

        async function loadCoursesTable() {
            const selectedSeason = getSelectedSeason();
            if (!selectedSeason) return;

            const { data: rounds } = await supabase
                .from('rounds')
                .select('id, course_name, course_multiplier')
                .eq('season', selectedSeason);

            if (!rounds || rounds.length === 0) {
                document.getElementById('coursesTable').innerHTML = '<p style="text-align: center; padding: 20px;">No data for this season</p>';
                return;
            }

            const roundIds = rounds.map(r => r.id);
            const { data: playerRounds } = await supabase
                .from('player_rounds')
                .select('round_id, player_name, final_total')
                .in('round_id', roundIds);

            if (!playerRounds) return;

            const roundMap = {};
            rounds.forEach(r => { roundMap[r.id] = r.course_multiplier || 1.0; });

            const playerStats = {};
            const playerTotalPoints = {};

            playerRounds.forEach(pr => {
                // Only count registered players
                if (!REGISTERED_PLAYERS.includes(pr.player_name)) return;

                const tier = roundMap[pr.round_id];
                if (!tier) return;
                if (!playerStats[pr.player_name]) {
                    playerStats[pr.player_name] = {};
                    playerTotalPoints[pr.player_name] = 0;
                }
                if (!playerStats[pr.player_name][tier]) playerStats[pr.player_name][tier] = { total: 0, count: 0 };
                playerStats[pr.player_name][tier].total += pr.final_total || 0;
                playerStats[pr.player_name][tier].count += 1;
                playerTotalPoints[pr.player_name] += pr.final_total || 0;
            });

            const allTiers = [...new Set(Object.values(roundMap))].sort((a, b) => b - a);
            let html = `<table><thead><tr><th>Player</th>`;
            allTiers.forEach(tier => { html += `<th>${tier.toFixed(2)}x</th>`; });
            html += `</tr></thead><tbody>`;

            // SORT BY TOTAL SEASON POINTS (descending)
            const sortedPlayers = Object.keys(playerStats)
                .sort((a, b) => playerTotalPoints[b] - playerTotalPoints[a]);

            sortedPlayers.forEach(player => {
                html += `<tr><td><strong>${player}</strong></td>`;
                allTiers.forEach(tier => {
                    const stats = playerStats[player][tier];
                    html += stats ? `<td>${(stats.total / stats.count).toFixed(1)}</td>` : `<td style="color: #555;">-</td>`;
                });
                html += `</tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('coursesTable').innerHTML = html;
        }

        async function loadMonthlyTrend() {
            const selectedSeason = getSelectedSeason();
            if (!selectedSeason) return;

            const { data: rounds } = await supabase
                .from('rounds')
                .select('id, date')
                .eq('season', selectedSeason)
                .order('date', { ascending: true });

            if (!rounds || rounds.length === 0) return;

            const roundIds = rounds.map(r => r.id);
            const { data: playerRounds } = await supabase
                .from('player_rounds')
                .select('round_id, player_name, final_total')
                .in('round_id', roundIds);

            if (!playerRounds) return;

            const roundDateMap = {};
            rounds.forEach(r => { roundDateMap[r.id] = r.date; });

            const playerMonthlyData = {};
            playerRounds.forEach(pr => {
                // Only count registered players
                if (!REGISTERED_PLAYERS.includes(pr.player_name)) return;

                const date = roundDateMap[pr.round_id];
                if (!date) return;
                const month = date.substring(0, 7);
                if (!playerMonthlyData[pr.player_name]) playerMonthlyData[pr.player_name] = {};
                if (!playerMonthlyData[pr.player_name][month]) playerMonthlyData[pr.player_name][month] = 0;
                playerMonthlyData[pr.player_name][month] += pr.final_total || 0;
            });

            const allMonths = [...new Set(Object.values(roundDateMap).map(d => d.substring(0, 7)))].sort();
            const colors = ['#64ffda', '#ff6b6b', '#4ecdc4', '#95e1d3', '#f38181', '#aa96da', '#fcbad3', '#a8d8ea'];
            const datasets = Object.entries(playerMonthlyData).map(([player, months], index) => ({
                label: player,
                data: allMonths.map(month => months[month] || 0),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '40',
                tension: 0.3,
                fill: false,
                borderWidth: 2
            }));

            const ctx = document.getElementById('monthlyTrendChart');
            if (monthlyTrendChart) monthlyTrendChart.destroy();
            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allMonths, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'top', labels: { color: '#64ffda', font: { size: 12 } } } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Points', color: '#64ffda' }, ticks: { color: '#e6f1ff' }, grid: { color: 'rgba(100, 255, 218, 0.1)' } },
                        x: { title: { display: true, text: 'Month', color: '#64ffda' }, ticks: { color: '#e6f1ff' }, grid: { color: 'rgba(100, 255, 218, 0.1)' } }
                    }
                }
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            if (!question) return;

            const chatBox = document.getElementById('chatBox');
            const chatSection = document.getElementById('chatSection');
            chatBox.classList.add('visible');
            chatSection.classList.add('expanded');

            addMessage(question, 'user');
            input.value = '';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            try {
                const response = await fetch(N8N_CHATBOT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                const data = await response.json();
                addMessage(data.answer || 'Sorry, I could not process that question.', 'bot');
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('Error: Could not connect to chatbot.', 'bot');
            }

            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
        }

        function addMessage(text, type) {
            const chatBox = document.getElementById('chatBox');
            const message = document.createElement('div');
            message.className = `message ${type}-message`;
            message.style.whiteSpace = 'pre-wrap';
            message.textContent = text;
            chatBox.appendChild(message);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Initialize: Load seasons first, then load data
        async function initialize() {
            await loadSeasons();
            await loadAllData();
        }

        initialize();
        setInterval(loadAllData, 300000); // Auto-refresh every 5 minutes
    </script>
</body>
</html>
